# PacePro Full Audit — January 30, 2026

## Critical Issues (blocks functionality)

### C1. Mobile ↔ Backend Auth Mismatch
**Files:** `src/app/api/chat/route.ts`, `src/app/api/plans/generate/route.ts`, `pacepro-mobile/lib/api.ts`

The backend API routes (`/api/chat`, `/api/plans/generate`) use cookie-based Supabase auth via `createClient()` from `@supabase/ssr`. The mobile app sends a Bearer token in the `Authorization` header. There is no middleware to convert Bearer tokens to cookie sessions.

**Impact:** Mobile chat and plan generation API calls will return 401 Unauthorized. The `supabase.auth.getUser()` call in the API routes won't find a session from the Bearer token.

**Fix:** Modify API routes to support both auth methods — check for Bearer token first, fall back to cookies. Or create a shared `getAuthUser(req)` helper.

### C2. `plan_adjustment` message_type Not in DB CHECK Constraint
**Files:** `src/app/api/chat/route.ts:94`, `src/lib/coach/adaptation.ts:577`, `supabase/migrations/001_coach_intelligence.sql:47-48`

Both the chat plan modifier and adaptation engine insert chat messages with `message_type: 'plan_adjustment'`, but the DB CHECK constraint only allows: `chat`, `workout_analysis`, `weekly_outlook`, `daily_checkin`, `recovery_alert`, `system`.

**Impact:** Plan adjustment messages will fail to insert with a DB constraint violation error.

**Fix:** Add migration: `ALTER TABLE chat_messages DROP CONSTRAINT ... ADD CONSTRAINT ... CHECK (message_type IN (..., 'plan_adjustment'))`.

### C3. `intensity` Column Missing from Workouts Table
**Files:** `src/lib/coach/chat-plan-modifier.ts`, `src/lib/coach/adaptation.ts`, `supabase/schema.sql`

The chat-plan-modifier writes `intensity: "easy"` to workouts, and the adaptation engine writes `intensity` changes. But the `workouts` table schema has no `intensity` column. The plan-engine stores intensity inside `target_zones` (JSONB).

**Impact:** Writes to the `intensity` column will silently fail or error depending on Supabase config. The workout detail screen reads `workout.intensity` which will always be null.

**Fix:** Add migration: `ALTER TABLE workouts ADD COLUMN IF NOT EXISTS intensity TEXT CHECK (intensity IN ('easy', 'moderate', 'hard', 'max'))`. Also update plan-engine to write intensity at the row level (not just in target_zones).

## Major Issues (incorrect behavior)

### M1. `/api/plans/extend` Route Missing
**Files:** `src/lib/coach/plan-engine.ts` exports `extendPlan()`, no route file exists

The plan engine has a full `extendPlan()` function for generating the next week of workouts on a rolling basis, but there's no API route to call it. Cron jobs or frontend can't trigger plan extension.

**Fix:** Create `/api/plans/extend/route.ts`.

### M2. Onboarding Store TypeScript Type Mismatch
**File:** `pacepro-mobile/lib/onboarding-store.ts:15`

The `coachStyle` type is `'supportive' | 'balanced' | 'push_me_hard'`, but the personality screen writes `'push'` (the correct canonical value). The type is wrong.

**Impact:** TypeScript type is misleading (though runtime value is correct due to `as any` cast in personality.tsx). Could cause confusion for future development.

**Fix:** Change to `coachStyle?: 'supportive' | 'balanced' | 'push'`.

### M3. WorkoutCard Has Hardcoded Mock Data in Expandable Section
**File:** `pacepro-mobile/components/calendar/WorkoutCard.tsx:139-160`

The fallback expandable section (when no `id` is present) shows hardcoded "10 min warm-up (easy)", "7:15/mi", "Zone 3-4", "Focus on maintaining steady effort" — all fake data.

**Impact:** If a workout card is rendered without an `id` (shouldn't happen now, but defensive), users see fake data instead of empty state.

**Fix:** Remove the hardcoded fallback section entirely since all workout cards now have `id` props and navigate to the detail screen.

### M4. `target_zones` Displayed as Raw JSON
**File:** `pacepro-mobile/app/workout/[id].tsx:~280`

The workout detail screen falls back to `JSON.stringify(workout.target_zones)` which shows ugly raw JSON to the user.

**Fix:** Format target_zones into human-readable text (e.g., "Pace: 5:00-5:30/km, HR: Zone 2-3").

## Minor Issues (cosmetic/cleanup)

### m1. `completeWorkoutManual` Called Without Feedback
**File:** `pacepro-mobile/app/workout/[id].tsx`

The "Complete" button calls `completeWorkoutManual(workout.id)` without collecting RPE, notes, or actual duration. The function supports optional `feedback` param.

**Suggestion:** Add a completion modal that collects RPE and notes before marking complete.

### m2. `CoachSays` Always Receives `undefined`
**File:** `pacepro-mobile/app/(tabs)/index.tsx`

Dashboard passes `latestInsight={undefined}` to CoachSays. Should fetch the latest coach insight from chat_messages.

### m3. `userId` Sent in Chat/Plan Body is Unnecessary
**Files:** `pacepro-mobile/lib/api.ts:124,258`

The mobile app sends `userId` in the request body for chat and plan generation, but the backend gets userId from auth. The body field is ignored (correctly, for security), but it's unnecessary payload.

### m4. Vercel Cron Schedule Inconsistency
**File:** `vercel.json`

Daily check-in runs at `0 11 * * *` (11 AM UTC = 5 AM CT), but the cron route has timezone-aware logic checking for ~6 AM local time. The cron should run frequently enough to catch different timezones, or be aligned to the target timezone.

### m5. Chat `action=new_workout` Adds Local Coach Message
**File:** `pacepro-mobile/app/(tabs)/chat.tsx`

When navigating with `action=new_workout`, a coach message is added locally without going through the backend. This message won't be persisted and won't appear on reload.

## Verified Working ✅

- Both projects compile clean (`npx tsc --noEmit` passes)
- Chat API route correctly returns both `response` and `reply` fields
- All 4 background tasks in chat route (preferences, compression, workout creation, plan modification) are properly wired as non-blocking
- Chat plan modifier has solid keyword heuristic pre-filter and all 8 modification types
- Injury protocol correctly maps body parts to affected sports and handles 3 severity levels
- Coach prompts have full dynamic system prompt with 3 coaching styles (supportive/balanced/push) + sport emphasis + response length + focus areas
- Adaptation engine handles post-workout comparison, recovery-based adjustment, and missed workout detection with style-aware messaging
- Plan engine generates periodized plans with proper phase calculation, deload weeks, sport-specific templates, zone-based prescriptions, and AI coach notes
- Onboarding flow: 8 screens → completeOnboarding() → generateTrainingPlan() → all correct
- Settings TrainingProfile uses correct label/value pairs matching onboarding for all options
- Chat settings modal has 3 canonical coach style options
- Strava webhook uses service role client (correct for server-to-server)
- Recovery check cron runs adaptation engine AND sends alerts (correct separation)
- Daily check-in cron handles missed workouts before generating check-in (correct order)
- All cron routes verify CRON_SECRET
- Empty states present on dashboard, calendar, analytics, chat
- "Coming Soon" alerts on social login, connect buttons, subscription
- Pull-to-refresh on all main screens
- Workout detail screen properly handles scheduled/completed/skipped states
- PlanOverview component correctly sorts key sessions by importance
- Auth flow (login → onboarding check → tabs) is properly structured
