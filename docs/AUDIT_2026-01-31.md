# PacePro Comprehensive Audit — 2026-01-31

**Auditor**: Automated Code Audit
**Scope**: Backend (Vercel/Next.js) + Mobile (React Native/Expo)
**Files Reviewed**: 80+ files across both codebases

---

## 1. Critical Issues (will crash or break core flows)

### 1.1 Strava Webhook Token Refresh Not Implemented
**File**: `src/app/api/webhooks/strava/route.ts`, line ~116 (`fetchStravaActivity`)
**Impact**: All Strava activity syncing will silently fail once access tokens expire (every 6 hours).

The `fetchStravaActivity` function uses the stored `access_token` directly but never checks `token_expires_at` or refreshes expired tokens. Strava access tokens expire every ~6 hours. Once expired, all webhook processing silently fails because the function returns `null` on non-200 responses, and the outer `processStravaActivity` just logs the error and moves on.

**Fix**: Implement token refresh before calling the Strava API. Check `integration.token_expires_at`, and if expired, use `refresh_token` to get a new `access_token` via Strava's `POST /oauth/token` with `grant_type=refresh_token`.

### 1.2 Webhook Event ID Mismatch — Events Never Marked as Processed
**File**: `src/app/api/webhooks/strava/route.ts`, lines ~73 and ~150
**Impact**: Webhook events are never correctly updated to `processed=true`, causing stale data.

On line 73, the event is inserted with `event_id: \`${event.object_id}-${event.event_time}\``. On line 150, the update query uses `event_id: \`${activityId}-${Date.now()}\``. These will **never match** because `event.event_time` ≠ `Date.now()`. The `processed` flag is never set to `true`.

**Fix**: Store the original event_id and use it consistently, or fetch the event row by a different key.

### 1.3 `buildCoachContext` Crashes When Profile is NULL
**File**: `src/lib/coach/context.ts`, line ~91 onward
**Impact**: If a profile doesn't exist (e.g., trigger failed, race condition during signup), the function returns `{ athlete: null, ... }` but all downstream code (AI calls, formatContextForAI) accesses `context.athlete.id`, `context.athlete.full_name`, etc. — resulting in a runtime crash.

The `profile` variable comes from `.single()` which returns `null` if no row is found, but the code does `return { athlete: profile as AthleteProfile }` without a null check.

**Fix**: Add a null check after fetching the profile and throw a clear error: `if (!profile) throw new Error('Profile not found for user');`

### 1.4 Onboarding "Ready" Screen Can Save Stale Data on Retry
**File**: `pacepro-mobile/app/(onboarding)/ready.tsx`, lines ~82-93
**Impact**: On retry after failure, `onboardingStore.reset()` may have already been called, causing the retry to send empty/default data.

The `saveOnboarding` function captures `onboardingData` via `useState(() => onboardingStore.get())` on mount. If it succeeds, it calls `onboardingStore.reset()`. Then if `saveOnboarding` is re-invoked (retry), it calls `onboardingStore.get()` again — which now returns `{}` because the store was reset. The fallback to `onboardingData` is correct, but the code path `const currentData = onboardingStore.get(); const dataToSave = Object.keys(currentData).length > 0 ? currentData : onboardingData;` is fragile: if the user fast-taps retry, `currentData` could be `{}` and `onboardingData` would be used — which is fine. But the success path already cleared the store, so a subsequent retry post-success would silently re-save the initial data. Not strictly a crash, but leads to unexpected behavior.

### 1.5 Chat API Background Tasks Use Stale Supabase Client (Potential Auth Expiry)
**File**: `src/app/api/chat/route.ts`, lines ~53-77
**Impact**: Background `.then()` chains use the `supabase` client from `getApiUser`, which was created from the user's JWT. If the JWT expires between response send and background task execution, these operations may fail silently.

The four background tasks (preference extraction, memory compression, workout creation, plan modification) are fire-and-forget `.then()` chains. Vercel serverless functions may terminate before these complete, especially under cold-start conditions. More critically, the Supabase client bound to the user's JWT could fail if the token expires.

**Fix**: Use a service-role Supabase client for background tasks, or execute them synchronously (at the cost of latency).

---

## 2. Major Issues (significant bugs or missing logic)

### 2.1 Weekly Outlook Cron Filters by `subscription_status = 'active'` But Default is `'inactive'`
**File**: `src/app/api/cron/weekly-outlook/route.ts`, line ~35
**Schema**: `supabase/schema.sql`, line ~28: `subscription_status TEXT DEFAULT 'inactive'`
**Impact**: No free-tier users will ever receive weekly outlook messages. This effectively disables the feature for all users who haven't explicitly subscribed.

**Fix**: Either remove the `subscription_status` filter or change it to filter on a real subscription check.

### 2.2 Plan Engine Coach Notes Batch Splitting Bug
**File**: `src/lib/coach/plan-engine.ts`, lines ~1470-1490 (within `generatePlan`)
**Impact**: AI coach notes may be assigned to wrong workouts because the batch splitting logic is incorrect.

```typescript
const weekSummaries = allWorkoutSummaries.slice(
  summaryOffset,
  summaryOffset + Math.ceil(weekTemplateCount / weekMetasUsed.length)
);
```

`weekTemplateCount` is calculated as `allWorkoutSummaries.filter((_s, i) => i >= summaryOffset).length`, which counts ALL remaining summaries, not just the current week's. Then it divides by `weekMetasUsed.length`. For 2 weeks with 5 and 4 workouts respectively, week 1 would get `ceil(9/2) = 5` summaries (correct by luck), but week 2 would get `ceil(4/2) = 2` summaries (wrong — should be 4).

**Fix**: Track how many templates belong to each week separately instead of using this approximation.

### 2.3 Memory Compression Uses Deprecated Model
**File**: `src/lib/coach/memory.ts`, lines ~67, ~91
**Impact**: `gpt-4-turbo-preview` may be deprecated or have different behavior than expected. Same issue in `preferences.ts` line ~95 and `chat-plan-modifier.ts` line ~124, `workout-creator.ts` line ~72.

Multiple files use `gpt-4-turbo-preview` while the main chat uses `gpt-4o`. This inconsistency means different parts of the system have different quality/cost profiles. More importantly, `gpt-4-turbo-preview` is an older snapshot that may be removed.

**Fix**: Standardize on `gpt-4o` or `gpt-4o-mini` for all calls. Use a shared constant for the model name.

### 2.4 No WHOOP Recovery Data Polling Implementation
**Files**: `src/app/api/integrations/whoop/callback/route.ts`, `src/app/api/cron/recovery-check/route.ts`
**Impact**: The WHOOP OAuth flow stores tokens but **no code ever fetches recovery data from WHOOP's API**. The `recovery_data` table can only be populated manually. The entire recovery-based adaptation system is non-functional for WHOOP users.

**Fix**: Implement a WHOOP data sync endpoint/cron that fetches recovery cycles, sleep, and strain data from the WHOOP API and inserts into `recovery_data`.

### 2.5 Strava Webhook: No Idempotency Check
**File**: `src/app/api/webhooks/strava/route.ts`, lines ~50-55
**Impact**: If Strava retries a webhook (which it does on timeouts), the same activity will be processed multiple times — creating duplicate workout entries for unscheduled activities and sending duplicate analysis messages.

The code logs the event and checks `aspect_type === "create"`, but never checks if this `object_id` was already processed.

**Fix**: Before processing, check if a workout with this `strava_activity_id` already exists.

### 2.6 `ConnectedApps` Component Doesn't Actually Connect Anything
**File**: `pacepro-mobile/components/settings/ConnectedApps.tsx`, line ~33
**Impact**: The "Connect" buttons for all integrations just show `Alert.alert("Coming Soon", ...)`. Users cannot connect Strava/WHOOP from the mobile app. The backend has OAuth routes but they use cookie-based auth which doesn't work from a mobile app.

**Fix**: Implement deep-link OAuth flow for mobile (open system browser → OAuth → redirect back to app via custom URL scheme).

### 2.7 Plan Extension Cron Not Configured
**File**: `docs/COACH_ARCHITECTURE.md` mentions "Weekly cron (Monday) → extend plan by 1 week" but there is no cron job that calls `/api/plans/extend`. The endpoint exists but is never triggered automatically.

**Impact**: Plans will run out after 2 weeks and no new workouts will be generated. Users will see an empty calendar after week 2.

**Fix**: Create a weekly cron job (e.g., via Vercel Cron) that calls `POST /api/plans/extend` for all active plan users.

### 2.8 `completeOnboarding` Doesn't Save Preferences Correctly for Plan Engine
**File**: `pacepro-mobile/lib/api.ts`, `completeOnboarding` function
**Impact**: The `preferences` object saved during onboarding includes `preferred_time`, `longer_workouts`, and `goals` — but the plan engine reads `preferences.longerWorkouts` (camelCase) while onboarding saves `longer_workouts` (snake_case). Same mismatch for other fields.

In `plan-engine.ts` line ~1406: `const prefs = (athlete.preferences || {})` and then `prefs.longer_workouts as string` — this matches. But onboarding saves the key as `longer_workouts` and the plan engine reads `longer_workouts`, so this one is actually okay. However, `workout_likes` and `workout_dislikes` are initialized as empty arrays in the migration default but never populated from onboarding — the onboarding flow doesn't ask about workout preferences.

### 2.9 No Timezone Handling in Plan Generation
**File**: `src/lib/coach/plan-engine.ts`
**Impact**: `new Date()` uses server timezone (UTC on Vercel). For a user in UTC-8, workouts for "today" may be scheduled on the wrong date (tomorrow in their timezone). The `toISODate` helper uses `toISOString().split("T")[0]` which is UTC-based.

### 2.10 Chat Messages Duplicated in History
**File**: `src/app/api/chat/route.ts`, lines ~27-42
**Impact**: The user message is inserted into `chat_messages` on line 27. Then on line 35, `recentMessages` are fetched (which now includes the just-inserted user message). This means the user message appears twice in the prompt: once in the `history` array and once as the explicit `userMessage` parameter in `coachChat`.

In `ai.ts` line ~51-60: the history is passed as messages, then the user message is appended again. So the model sees the user message twice.

**Fix**: Either don't insert the user message before fetching history, or exclude the current message from history.

---

## 3. Coaching Quality Review

### 3.1 System Prompt Effectiveness
**Rating**: 7/10

The base prompt (`COACH_SYSTEM_PROMPT`) is well-structured with clear personality, knowledge, and behavioral guidelines. The `NEVER` section is useful. However:

- The 150-word limit in the base prompt conflicts with the "Detailed" response_length option (which says 200-300 words). The dynamic section should override, but both are present in the final prompt.
- No mention of the athlete's sport in the base prompt — it's generic "endurance coach." The sport-specific emphasis is added dynamically, which is correct, but the base prompt references "5K to ultramarathon" and "swim/bike/run" which feels redundant with the dynamic sport section.

### 3.2 Coaching Style Differentiation
**Rating**: 8/10 — Good

The three styles (supportive, balanced, push) are meaningfully different:

- **Supportive**: Celebrates effort, frames failures as opportunities, backs off on yellow recovery. Clear patient tone.
- **Balanced**: Acknowledges + looks ahead, honest about improvements, still proceeds on yellow.
- **Push**: High expectations, only red recovery matters, "don't let them settle" mentality.

The differentiation is well-done. The adaptation engine correctly uses coaching style to determine behavior (e.g., `adaptForRecovery` treats yellow differently per style). However, the `COACHING_PHILOSOPHY.md` document hardcodes "Push" mode (Section 6: "Mode: PUSH"), which contradicts the dynamic style system. This document appears to be aspirational/for a specific athlete rather than the system default.

### 3.3 Context Usage
**Rating**: 7/10

`formatContextForAI` does a good job compressing context — it includes athlete profile, plan phase, today's workout, recent workouts, recovery, and long-term memory. However:

- **Missing**: Upcoming workouts are fetched in `buildCoachContext` but NOT included in `formatContextForAI`. The coach can't see what's coming up, which limits its ability to give forward-looking advice.
- **Missing**: Weekly volume is included as "minutes" but not contextualized against the target.
- The conversation summary (`athlete.conversation_summary`) is included, which is excellent for continuity.

### 3.4 Preference Extraction & Storage
**Rating**: 8/10

The preference system is sophisticated:
- `PREFERENCE_EXTRACTION_PROMPT` is well-designed with specific categories
- `mergePreferences` handles deduplication via normalized string comparison and Jaccard similarity
- Contradiction detection uses both heuristic patterns and AI fallback
- Conservative extraction (explicit statements only) is the right approach

**Issue**: AI contradiction checking (`findAIContradictions`) only activates when there are ≥3 existing preferences. For users with 1-2 existing prefs, contradictions won't be caught.

### 3.5 Plan Engine Quality
**Rating**: 7/10

Strengths:
- Proper periodization (base → build → peak → taper) with correct phase allocation
- Deload weeks every 4th week
- Non-adjacent hard day scheduling
- Sport-specific templates (running, triathlon, cycling) with appropriate workout distribution
- Pace/power zone calculations are physiologically sound
- Detailed workout descriptions with warmup/main/cooldown structure

Weaknesses:
- **Swimming templates are thin**: Only technique/endurance/speed sessions. No CSS-based training, no drill variety, no open-water prep
- **No progressive overload**: Week 1 and Week 2 have the same volume within a phase. The plan doesn't progressively increase volume week over week — it only changes at phase boundaries and deload weeks
- **Race-specific pacing not derived from goal time**: The plan uses easy pace to derive all zones, but doesn't back-calculate from `goal_finish_time` to determine race-specific paces
- **Brick workouts in triathlon**: Only bike→run, never swim→bike (T1 practice)
- **Volume percentages don't sum to 100%**: In running base phase, `0.3 + 0.2 + 0.15*3 = 0.95` — close but not exact. This means ~5% of weekly volume is unaccounted for.

### 3.6 Adaptation Logic
**Rating**: 8/10

The adaptation engine is well-designed:
- Post-workout analysis correctly compares actual vs. prescribed
- Recovery-based adaptation correctly uses the red/yellow/green zones with per-style behavior
- Missed workout handling correctly differentiates key vs. non-key sessions
- Injury protocol with body-part → sport mapping is clever
- `executeAdaptationActions` properly updates DB rows

**Issue**: The adaptation engine never *increases* difficulty. It only responds to fatigue/misses/low recovery. Per the coaching philosophy, consistently beating targets should trigger prescription increases. This is documented in `COACHING_PHILOSOPHY.md` Section 8 but not implemented.

### 3.7 Chat-Plan-Modifier
**Rating**: 7/10

The keyword heuristic is comprehensive and prevents unnecessary GPT calls. The modification types cover the main scenarios. Injury protocol with automatic sport swapping is well-implemented.

**Issue**: The `executeChanges` function finds workouts by date + optional type using `.limit(1).single()`. If there are multiple workouts on the same date (common in triathlon — swim in morning, run in evening), it may modify the wrong one. The query should also consider the workout title or use more specific matching.

---

## 4. Data Flow Issues

### 4.1 Mobile API Authentication
**Rating**: 7/10

`getApiUser` correctly handles both Bearer token (mobile) and cookie-based (web) auth. The mobile client sends the Supabase JWT as a Bearer token, which is verified server-side.

**Issue**: Mobile calls to Supabase directly (via `lib/api.ts`) use the anon key + user's session, which means RLS policies apply. But API route calls (`sendChatMessage`, `generateTrainingPlan`) go through the Vercel backend where a service-role client is used. This inconsistency means:
- Direct Supabase calls are safe (RLS enforced)
- API calls use service-role for writes but user auth for reads — generally fine but needs careful auditing of each route

### 4.2 Missing Error Handling in Mobile
- `getLatestRecovery` throws on error but dashboard (`app/(tabs)/index.tsx`) wraps the entire `loadData` in a single try/catch. If recovery fetch fails, ALL dashboard data (workouts, plan, insights) is lost.
- `sendChatMessage` in `lib/api.ts` doesn't pass `userId` to the backend (the backend derives it from the JWT), but the function signature accepts `_userId` — misleading. The actual `user_id` parameter in the body is absent.
- `completeWorkoutManual` doesn't include `perceived_effort` in the DB update — the schema has this field but it's never populated from the manual completion flow. The RPE is stored in `actual_data.rpe` instead.

### 4.3 Race Conditions
- **Chat message ordering**: The user message is inserted, then history is fetched, then the response is generated and inserted. If two messages are sent rapidly, the history for the second message might include the first response before it's been inserted (or might not — timing-dependent).
- **Plan generation**: If a user taps "Generate Plan" twice quickly (e.g., on the dashboard), two plans could be created simultaneously. The cancellation of the previous active plan happens first, but both requests could pass the cancellation step before either creates a new plan.
- **Onboarding completion**: The ready screen calls `completeOnboarding` and `generateTrainingPlan` in parallel. If the plan generation starts before the profile is fully saved, it could read stale/incomplete profile data.

### 4.4 Data Sync Gaps
- **No real-time updates**: The mobile app uses polling (pull-to-refresh). There are no WebSocket subscriptions or real-time listeners for new coach messages, workout updates, or plan modifications. This means:
  - Daily check-in messages won't appear until the user manually refreshes
  - Recovery alerts won't appear until refresh
  - Plan modifications from the adaptation engine won't be visible until refresh

---

## 5. UX Issues

### 5.1 Dead Buttons & Missing Navigation
- **Social login buttons** (Apple, Google) on both login and signup screens show "Coming Soon" alerts and have `opacity-50`. These should either be hidden or properly implemented.
- **Wearables screen** during onboarding shows all devices as "Available in Settings" but Settings doesn't actually allow connecting them (see issue 2.6).
- **Terms of Service** and **Privacy Policy** links in signup (`router.push("/(auth)/terms")`) — these routes don't exist in the codebase. They will crash if tapped.
- **Goal Race editing** in TrainingProfile settings modal says "Race editing coming soon" — dead end.

### 5.2 Empty States
- **Calendar month view** (`MonthCalendar` component): The component is imported but the actual `MonthCalendar.tsx` was not read. The month view has no workout indicators on days — the month calendar appears to be purely a date picker without visual workout data.
- **Analytics screen**: When there's no data, `RaceReadiness` returns `null` (score < 5 completed workouts). The other components may show empty states but there's no unified "complete some workouts first" message.
- **Dashboard without a plan**: Shows "Generate Plan" button which is good, but no explanation of what the plan will include.

### 5.3 Inconsistencies
- **Chat message roles**: Backend stores `role: "assistant"`, mobile maps this to `role: "coach"`. The type system uses `MessageRole = 'user' | 'coach'` in types/index.ts but the API returns `'user' | 'assistant'`. This mapping happens in `chat.tsx` but would break if used elsewhere.
- **Workout status naming**: Backend uses `'scheduled' | 'completed' | 'skipped' | 'modified'`, mobile types use `'completed' | 'today' | 'upcoming' | 'skipped'`. The calendar translates between these correctly, but it's a maintenance hazard.
- **Sport type**: Backend uses `'swim' | 'bike' | 'run' | 'strength' | 'rest' | 'brick'`, types/index.ts matches, but the calendar `sportType` function returns `null` for `strength` and `rest` — they won't show sport-specific styling.

### 5.4 Loading States
- **Chat screen**: Has a good loading state (ActivityIndicator) and a safety timeout of 8 seconds.
- **Calendar**: Shows an ActivityIndicator during load — good.
- **Dashboard**: No skeleton loading — the screen just shows empty space while data loads. Pull-to-refresh works.
- **Workout detail screen**: Good loading and not-found states.
- **Analytics**: No loading skeleton. Data pops in after fetch.

### 5.5 Missing Scroll/Keyboard Handling
- **Chat input**: On Android, `KeyboardAvoidingView` with `behavior="height"` may not work correctly on all devices. The chat input might be obscured by the keyboard.
- **Onboarding goals screen**: The ScrollView is good, but the time picker (when "Hit a specific time" is selected) pushes content below the fold without auto-scrolling to it.

---

## 6. Performance Concerns

### 6.1 Multiple AI Calls Per Chat Message
Each chat message triggers up to **5 AI calls** (all using GPT-4o or GPT-4-turbo):
1. Main chat response (`coachChat`) — GPT-4o
2. Preference extraction (`extractPreferences`) — GPT-4o
3. Workout creation check (`extractAndCreateWorkout`) — GPT-4-turbo
4. Plan modification detection (`detectAndExecutePlanModification`) — GPT-4-turbo
5. Memory compression (occasionally) — GPT-4-turbo

At current GPT-4o pricing ($2.50/$10 per 1M tokens), this could cost $0.02-0.08 per message. For a user sending 20 messages/day, that's $0.40-1.60/day per user. The preference extraction and workout creation checks could use GPT-4o-mini to reduce costs significantly.

### 6.2 Plan Generation Makes N+1 AI Calls
`generatePlan` calls `generateCoachNotesBatch` once per week. For a 2-week initial generation with 10 workouts, that's 2 AI calls. But each call sends the entire workout list for that week. This is efficient per call but the response parsing assumes a JSON array format that may not always match.

### 6.3 Recovery Check Cron Iterates All Users
`recovery-check/route.ts` fetches all users with today's recovery data, then for each user makes 3-4 DB queries and potentially 1 AI call. With 10,000 users, this could timeout on a Vercel serverless function (default 10s for hobby, 60s for pro).

**Fix**: Process users in batches, or use a queue system.

### 6.4 Mobile: Full Workout Fetches Without Pagination
`api.ts` `getPersonalRecords` fetches ALL completed workouts (no limit) to calculate PRs. For a user with 500+ completed workouts, this query could be slow and transfer significant data.

### 6.5 Context Building Fetches Everything
`buildCoachContext` makes 5 parallel Supabase queries for every chat message, daily check-in, recovery alert, etc. Even if only the profile is needed (e.g., for a simple question), all data is fetched. Consider a lighter-weight context for simple queries.

---

## 7. Security Issues

### 7.1 OAuth State Parameter is Not Stored/Verified Server-Side
**Files**: `src/app/api/integrations/strava/connect/route.ts`, `.../callback/route.ts`
**Impact**: The CSRF `state` parameter is generated as `base64url(userId:nonce:returnTo)` but the nonce is never stored server-side. The callback just decodes the state and extracts the userId — it doesn't verify the nonce. An attacker could craft a valid state parameter with a target userId and trick a victim into completing the OAuth flow, linking the attacker's Strava account to the victim's PacePro account.

**Fix**: Store the nonce in the user's session or a server-side store, and verify it in the callback.

### 7.2 Service Role Key Used as Auth Token
**File**: `src/app/api/plans/generate/route.ts`, line ~24
```typescript
const isServiceCall = authHeader === `Bearer ${process.env.SUPABASE_SERVICE_ROLE_KEY}`;
```
The service role key is being used as a Bearer token for API authentication. If this key leaks (e.g., in logs), an attacker could impersonate any user by passing `userId` in the body.

### 7.3 Chat Input Not Sanitized
**File**: `src/app/api/chat/route.ts`, line ~22
The message is validated as a string but not sanitized. While GPT-4 is relatively robust against prompt injection, the message is stored directly in the database and could contain XSS payloads if ever rendered in a web frontend.

### 7.4 OAuth Tokens Stored in Plain Text
**File**: `supabase/schema.sql`, `integrations` table
Access tokens and refresh tokens for Strava/WHOOP are stored as plain `TEXT` in the database. If the database is compromised, all user OAuth tokens are exposed.

**Fix**: Encrypt tokens at rest using a server-side encryption key.

### 7.5 API Routes Missing Rate Limiting
No rate limiting is implemented on any API route. A malicious user could:
- Send thousands of chat messages, incurring massive OpenAI costs
- Repeatedly generate training plans
- Spam the webhook endpoint

### 7.6 Mobile Supabase Direct Access
`lib/api.ts` makes many direct Supabase calls (e.g., `updateWorkoutStatus`, `skipWorkout`). While RLS policies restrict to the user's own data, there's no server-side validation. A user could:
- Mark workouts as completed without actually doing them (currently possible via `completeWorkoutManual`)
- Modify workout fields directly
- Delete their own data

This is acceptable for a trusted client but worth noting.

---

## 8. Missing Features (things that should exist but don't)

### 8.1 Push Notifications
No push notification system exists. The daily check-in, recovery alerts, and weekly outlooks are all stored as chat messages but users are never notified. They have to open the app and check manually.

### 8.2 WHOOP/Garmin/Apple Health Data Sync
OAuth flows exist for Strava and WHOOP, but only Strava has actual data fetching (via webhook). WHOOP tokens are stored but never used. Garmin, Apple Health, and Oura Ring are listed in the UI but have no backend implementation.

### 8.3 Strava Token Refresh
As noted in Critical Issue 1.1, there's no token refresh mechanism for any OAuth integration.

### 8.4 Plan Extension Cron Job
The plan only generates 2 weeks of workouts initially. There's an `extendPlan` endpoint but no cron job to call it weekly. Users will have an empty calendar after 2 weeks.

### 8.5 Workout Swap via Chat Feedback Loop
When a user taps "Swap" on a workout, it pre-fills a chat message. But the response from the coach and the actual plan modification are separate — the user doesn't get confirmation that the swap happened. The plan modification detection runs in the background and posts a separate message.

### 8.6 Offline Support
The mobile app has no offline capabilities. All screens require network access. No data caching, no queuing of messages when offline.

### 8.7 Plan Regeneration After Profile Changes
When a user changes their sport, experience level, weekly hours, or training days in Settings, the existing plan is NOT regenerated. The plan continues with the old parameters until manually regenerated.

### 8.8 Progressive Overload in Plans
Plans don't implement progressive overload within a phase. Week 1 and week 3 of the build phase have identical volume prescriptions (only deload weeks differ). Real training plans should increase volume 5-10% per week within a phase.

### 8.9 Race Taper Logic
The taper phase exists in the plan engine but there's no automatic detection that race week is approaching. If the plan was generated months ago and extended weekly, the phase tracking (`current_week`, `current_phase`) on the `training_plans` table is never updated.

### 8.10 Analytics: Historical Trends
The analytics screen shows current-state metrics but no historical trends (e.g., fitness over time, pace improvement charts, recovery score history).

### 8.11 Manual Activity Logging
Users can mark workouts as "completed" but can't log detailed actual data (pace, HR, distance). The manual completion only captures RPE and notes. Users without Strava integration have no way to provide detailed workout data.

### 8.12 Multi-Race Support
Only one goal race can be set. The schema supports `goal_race_date` and `goal_race_type` as single values. Many athletes have A-races and B-races, which require different periodization.

---

## 9. Recommended Priority Fixes (ordered by impact)

### P0 — Fix Before Launch

| # | Issue | Impact | Effort | Section |
|---|-------|--------|--------|---------|
| 1 | **Implement Strava token refresh** | All Strava syncing breaks after 6 hours | Medium | 1.1 |
| 2 | **Fix webhook event_id mismatch** | Events never marked processed, debugging impossible | Low | 1.2 |
| 3 | **Add null check in buildCoachContext** | Runtime crash when profile missing | Low | 1.3 |
| 4 | **Remove subscription_status filter from weekly outlook** | Feature disabled for all users | Low | 2.1 |
| 5 | **Fix duplicate user message in chat history** | Model sees message twice, wastes tokens | Low | 2.10 |
| 6 | **Add Strava webhook idempotency** | Duplicate workouts on webhook retries | Medium | 2.5 |
| 7 | **Create plan extension cron job** | Calendar empty after 2 weeks | Low | 2.7 |
| 8 | **Fix Terms/Privacy route crash** | App crashes on signup screen tap | Low | 5.1 |

### P1 — Fix Within First Month

| # | Issue | Impact | Effort | Section |
|---|-------|--------|--------|---------|
| 9 | **Implement mobile OAuth deep-link flow** | Users can't connect integrations | High | 2.6 |
| 10 | **Add push notifications** | Users miss daily check-ins, alerts | High | 8.1 |
| 11 | **Implement WHOOP data sync** | Recovery features non-functional | Medium | 2.4 |
| 12 | **Fix OAuth CSRF vulnerability** | Security issue — account linking attack | Medium | 7.1 |
| 13 | **Add API rate limiting** | Cost exposure, DDoS vulnerability | Medium | 7.5 |
| 14 | **Standardize AI model usage** | Cost consistency, deprecated model risk | Low | 2.3 |
| 15 | **Add real-time message subscriptions** | Better UX for proactive coach messages | Medium | 4.4 |
| 16 | **Handle timezone in plan generation** | Wrong-day scheduling for non-UTC users | Medium | 2.9 |
| 17 | **Reduce AI calls per message (use GPT-4o-mini for side tasks)** | ~60% cost reduction on background tasks | Low | 6.1 |

### P2 — Quality Improvements

| # | Issue | Impact | Effort | Section |
|---|-------|--------|--------|---------|
| 18 | **Implement progressive overload** | More effective training plans | Medium | 8.8 |
| 19 | **Add upcoming workouts to AI context** | Better forward-looking coaching | Low | 3.3 |
| 20 | **Auto-regenerate plan on profile changes** | Plan stays relevant when settings change | Medium | 8.7 |
| 21 | **Add upward adaptation** | Coach should increase load when athlete overperforms | Medium | 3.6 |
| 22 | **Fix batch note splitting in plan generation** | Coach notes may be misassigned | Low | 2.2 |
| 23 | **Add loading skeletons to dashboard** | Better perceived performance | Low | 5.4 |
| 24 | **Encrypt OAuth tokens at rest** | Security hardening | Medium | 7.4 |
| 25 | **Add offline support / data caching** | Usability without network | High | 8.6 |
| 26 | **Update current_phase on training_plans** | Phase tracking stays accurate | Medium | 8.9 |

---

*Audit complete. 8 critical/major issues identified, 18 significant concerns, and 12 missing features documented. The core architecture is solid — the coach system, plan engine, and adaptation logic are well-designed. The highest-priority fixes are the Strava token refresh, webhook idempotency, and plan extension cron job — without these, the two most important features (activity syncing and ongoing plan generation) are effectively broken.*
